<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xh:html
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:map="http://www.w3.org/2005/xpath-functions/map"
    xmlns:array="http://www.w3.org/2005/xpath-functions/array"
    xmlns:exf="http://www.exforms.org/exf/1-0"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:saxon="http://saxon.sf.net/"
    xmlns:sql="http://orbeon.org/oxf/xml/sql"
    xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
    xmlns:ctao="http://www.certus-tech.com/orbeon">
    <xh:head>
        <xh:title/>
        <xf:model id="fr-form-model" xxf:expose-xpath-types="true" xxf:analysis.calculate="true">

            <!-- Main instance -->
            <xf:instance id="fr-form-instance" xxf:exclude-result-prefixes="#all">
                <form>
                    <section-1>
                        <control-1/>
                    </section-1>
                </form>
            </xf:instance>

            <!-- Bindings -->
            <xf:bind id="fr-form-binds" ref="instance('fr-form-instance')">
                <xf:bind id="section-1-bind" name="section-1" ref="section-1">
                    <xf:bind id="control-1-bind" name="control-1" ref="control-1" xxf:whitespace="trim"/>
                </xf:bind>
            </xf:bind>

            <!-- Metadata -->
            <xf:instance id="fr-form-metadata" xxf:readonly="true" xxf:exclude-result-prefixes="#all">
                <metadata>
                    <ctao:use-history>false</ctao:use-history>
                    <application-name/>
                    <form-name/>
                    <title xml:lang=""/>
                    <description xml:lang=""/>
                </metadata>
            </xf:instance>

            <!-- Attachments -->
            <xf:instance id="fr-form-attachments" xxf:exclude-result-prefixes="#all">
                <attachments/>
            </xf:instance>

            <!-- All form resources -->
            <xf:instance id="fr-form-resources" xxf:readonly="true" xxf:exclude-result-prefixes="#all">
                <resources>
                    <resource xml:lang="">
                        <section-1>
                            <label/>
                        </section-1>
                        <control-1>
                            <label/>
                            <hint/>
                            <alert/>
                        </control-1>
                    </resource>
                </resources>
            </xf:instance>
            
            <!--
              Load history data when form is loaded, if enabled in the metadata instance & not readonly or running
              in the form designer. You must replace the PLACEHOLDER URL on the submission below before enabling history.
            -->
            <xf:action event="xforms-ready"
                       if="(instance('fr-form-metadata')/ctao:use-history = true()) and not(fr:is-readonly-mode()) 
                       and not(fr:is-design-time())">
              <xf:setvalue ref="instance('cta-form-history-parameters')/app" 
                           value="fr:app-name()"/> 
              <xf:setvalue ref="instance('cta-form-history-parameters')/form" 
                           value="fr:form-name()"/> 
              <xf:setvalue ref="instance('cta-form-history-parameters')/documentid"
                           value="fr:document-id()"/> 
              <xf:send submission="cta-form-history-submission"/>
            </xf:action>

            <!-- Contains side-loaded history. -->
            <xf:instance id="cta-form-history-instance" xxf:readonly="true" xxf:exclude-result-prefixes="#all">
                <history/>
            </xf:instance>
            
            <!-- Populated with details of the form and submitted in order to side-load the history instance. -->
            <xf:instance xxf:readonly="false" id="cta-form-history-parameters" xxf:exclude-result-prefixes="#all">
              <history-parameters>
                <app/>
                <form/>
                <documentid/>
              </history-parameters>
            </xf:instance>
            
            <!-- 
              Side-loads the history instance. You must replace the PLACEHOLDER URL below before enabling history.
            -->
            <xf:submission id="cta-form-history-submission" method="get"
                           action="PLACEHOLDER/b/WSFormHistory.do"
                           ref="instance('cta-form-history-parameters')"
                           replace="instance"
                           instance="cta-form-history-instance">
                <xf:action event="xforms-submit-error">
                    <xf:message>History load failed</xf:message>
                </xf:action>
            </xf:submission>

        </xf:model>
    </xh:head>
    <xh:body>
        <fr:view>
            <fr:body>
                <fr:section id="section-1-section" bind="section-1-bind">
                    <xf:label ref="$form-resources/section-1/label"/>
                    <fr:grid id="grid-1-grid">
                        <xh:tr>
                            <xh:td>
                                <xf:input id="control-1-control" bind="control-1-bind">
                                    <xf:label ref="$form-resources/control-1/label"/>
                                    <xf:hint ref="$form-resources/control-1/hint"/>
                                    <xf:alert ref="$fr-resources/detail/labels/alert"/>
                                </xf:input>
                            </xh:td>
                            <xh:td/>
                        </xh:tr>
                    </fr:grid>
                </fr:section>
            </fr:body>
        </fr:view>
    </xh:body>
</xh:html>
